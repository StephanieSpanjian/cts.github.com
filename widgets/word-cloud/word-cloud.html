<html>
<head>
</head>
<body>
  <section id="cloud"><div>

    <!-- This is the visible section of the CTS template -->

    <div class="thewordcloud"></div>

    <!-- This is the data section, insivible but present in the DOM -->

    <div class="worddata" style="display:none;" >
      <div class="important-words"></div>
      <div class="words"></div>
      <ul class="properties">
        <li class="width"></li>
        <li class="height"></li>
      </ul>
    </div>

    <!-- This is a script that will execute upon DOM insert -->

  <script>
    var RenderWordCloud = function(widget) {
      console.log("------ WIDGET Render JavaScript -------");
      var dataElem = widget.find(".worddata");
      var data = CTS.engine.recoverData(dataElem);
      console.log("WIDGET: Recovered Data", data);
      if ("words" in data) {
        var width = 600;
        var height = 500;
        if ("width" in data) {
          width = parseInt(data["width"]);
        }
        if ("height" in data) {
          height = parseInt(data["height"]);
        }
        console.log("here are the words: " + data["words"]);
        var smallWords = data["words"].split(" ");
        var bigWords = data["important"].split(" ");
        var w = new Array();
        var g = new Array();
        for (var i in bigWords) {
          w.push(bigWords[i]);
          g.push(2);
        }
        for (var j in smallWords) {
          w.push(smallWords[j]);
          g.push(1);
        }
        var colors = ["#000000", "#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#00FFFF", "#FF00FF"];
        d3.layout.cloud().size([width, height])
          .words(d3.zip(w, g).map(function(d) {
             return {text: d[0], size: d[1]==1? (10 + Math.random() * 30): 40+Math.random()*30};
           }))
           .rotate(function() { return Math.random() * 180-90; })
           .fontSize(function(d) { return d.size; })
           .on("end", draw)
           .start();

        function draw(words) {
          d3.select(".thewordcloud").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width/2 + "," + height/2+ ")")
            .selectAll("text")
            .data(words, function(d){return d;})
            .enter().append("text")
            .style("font-size", function(d) { return d.size + "px"; })
            .style("fill",function() { return colors[Math.floor(Math.random() * (7))];})
            .attr("text-anchor", "middle")
            .attr("transform", function(d) {
              return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
            })
            .text(function(d) { return d.text; });
         }
       }
    };
    
    // First, get the data
    var widget = CTS.Util.getLastInserted();
    if (widget) {
      RenderWordCloud(widget);
    }
  </script>

  </div></section>
</body>
</html>
